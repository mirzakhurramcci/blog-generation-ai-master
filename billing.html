<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>ContentBlitz - Billing</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link
      href="assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />

    <link href="assets/css/customStyles.css" rel="stylesheet" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- =======================================================
  * Template Name: Ninestars
  * Updated: May 30 2023 with Bootstrap v5.3.0
  * Template URL: https://bootstrapmade.com/ninestars-free-bootstrap-3-theme-for-creative/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  </head>

  <body>
    <header id="header" class="fixed-top d-flex align-items-center">
      <div class="container d-flex align-items-center justify-content-between">
        <div class="logo">
          <h1 class="text-light">
             
            <a href="home.html"><span>ContentBlitz</span></a>
          </h1>
          <!-- Uncomment below if you prefer to use an image logo -->
          <!-- <a href="home.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
        </div>

        <nav id="navbar" class="navbar">
          <ul>
            <li>
              <a class="nav-link scrollto" href="home.html">Projects</a>
            </li>
            <li>
              <a class="nav-link scrollto active" href="billing.html"
                >Billing </a
              >
            </li>
            <li class="nav-item dropdown">
              <img src="assets/img/profile_icon.png" alt="User Avatar" class="user-avatar nav-link dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <!-- Dropdown items go here -->
                <p class="dropdown-item" id="userEmail"></p>
                <p class="dropdown-item" id="userCredits"></p>
                <div class="dropdown-divider"></div>
                <span class="dropdown-item" id="onLogout" style="cursor: pointer;">Logout</span>
              </div>
            </li>
          </ul>
          <i class="bi bi-list mobile-nav-toggle"></i>
        </nav>
        <!-- .navbar -->
      </div>
    </header>

    <div class="container-fluid col-10" style="margin-top: 7rem">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="home.html">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Billing</li>
        </ol>
      </nav>
      <div class="card">
        <div class="row">
          <div class="col-sm-8">
            <div class="card-body">
              <h5 class="card-title">Purchase on-demand articles for $0.2</h5>
              <p class="card-text">
                All features included, no commitment. On-demand Articles are
                always available
              </p>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="card-body">
              <h5 id="card-title" class="card-title">$0.2 for 1 article</h5>
              <input value="1" step="1" min="1" max="50" id="sliderPurchase" type="range" style="width: 100%" />
              <button id="btnCheckoutPurchase" class="btn btn-primary btn-block">Buy now</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards -->

      <div id="billingCard" class="card-deck pt-4 mt-4 mb-3 border-top">
        
      </div>
    </div>

    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner"></div>
    </div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <script>
      $(document).ready(function() {

        var user = JSON.parse(localStorage.getItem("user"));

        showLoadingSpinner();

        function showLoadingSpinner() {
          $("#loadingSpinner").show();
        }

        // Function to hide the loading spinner
        function hideLoadingSpinner() {
          $("#loadingSpinner").hide();
        }

        if (!user) {
          window.location.href = "/index.html";
        } else {
          $("#userEmail").text(user.email);
          $("#userCredits").text("Credits: " + user.credits);
        }

        $(document).on("click", "#onLogout", function() {
          // Code to be executed when the button is clicked
         localStorage.removeItem("user");
         window.location.href = "/index.html";
        });


        function populateUI(data) {
        var parent = $("#billingCard");
        
        $.each(data, function(index, item) {
          var cardDetails = $(`
          <div class="card">
              <div class="card-body">
                <h5 class="card-title">${item.title}</h5>
                <p>Try us at no cost</p>
                <p class="price"><span class="font-weight-bold">$${item.price}/mo</span></p>
                <p>${item.monthly_credits} articles</p>
                <button id="btnSubscribe" planId="${item.id}" class="btn btn-success">Choose Plan</button>
                <div class="included pt-4 mt-4 border-top">
                  <p class="font-weight-bold">What is included</p>
                  <ul>
                    <li>2 articles a month</li>
                    <li>Over 100 supported languages</li>
                  </ul>
                </div>
              </div>
            </div>   
            `);

            parent.append(cardDetails);
          });
       }
       
       $(document).on("change", "#sliderPurchase", function() {
          var noOfArticles = $('#sliderPurchase').val();
          var amountForArticle = parseFloat(noOfArticles * 0.2).toFixed(2);

          var textToShow = "$" + amountForArticle + " for " + noOfArticles + " articles";

          $("#card-title").text(textToShow);
       })

       $(document).on("click", "#btnSubscribe", function() {
          // Code to be executed when the button is clicked
          var user = JSON.parse(localStorage.getItem("user"));

          showLoadingSpinner();

          var planId = $(this).attr('planId');
          var customerId = user.stripeCustomerId;
          var userId = user.id;

          if (planId && planId.length > 0 && customerId && customerId.length > 0) {
            var apiURL = "https://app.contentblitz.ai:8080/api/v1/stripeSubscriptionCheckoutSession";

            var body = {
              customerId: customerId,
              planId: parseInt(planId)
            }

            $.ajax({
              type: "POST",
              url: apiURL,
              data: JSON.stringify(body),
              contentType: "application/json",
              success: function(response) {
                  // Handle the successful API response here
                  hideLoadingSpinner();
                  if (response.success && response.response_code === 0 ) {
                    if (response.hasOwnProperty('data')) {
                      
                      window.location.href = response.data.url
                    }
                  } else {
                    hideLoadingSpinner();
                    var errorMessage = $("#errorMessage");
                    errorMessage.text(response.message)
                  }
                  
              },
              error: function(error) {
                hideLoadingSpinner();
                  // Handle any errors that occur during the API call
                  console.error("Error:", error);
              }
            });
          }
        });

       $.ajax({
        type: "GET",
        url: "https://app.contentblitz.ai:8080/api/v1/billingPlans", // Replace with your API endpoint URL
        success: function(data) {
            // Call the function to populate the table with the fetched data
            console.log(data.data)
            hideLoadingSpinner();
            populateUI(data.data);
        },
        error: function(error) {
          hideLoadingSpinner();
            console.error("Error:", error);
        }
       });

       $.ajax({
        method: "GET",
        dataType: "json",
        url: "https://app.contentblitz.ai:8080/api/v1/getActiveSubscriptions?userId=" + userId, // Replace with your API endpoint URL
        success: function(data) {
            // Call the function to populate the table with the fetched data
            console.log(data.data)
            populateUI(data.data);
        },
        error: function(error) {
            console.error("Error:", error);
        }
       });

      });
    </script>
  </body>
</html>
